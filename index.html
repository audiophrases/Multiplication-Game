<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Multiplication Mania!</title>
  <style>
    :root {
      --primary: #4b9cff;
      --secondary: #ffcc4b;
      --bg: radial-gradient(circle at top left, #f7fbff, #dfe9f7);
    }

    * { box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
    body {
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background: var(--bg);
      color: #0f1b2d;
      font-size: clamp(18px, 2vw, 22px);
    }

    header, footer {
      background: linear-gradient(90deg, #0f1b2d, #183c5a);
      color: #fff;
      padding: 18px 20px;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      letter-spacing: 0.3px;
    }

    main {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    #header-info { font-size: 1.2em; font-weight: 700; }
    #header-info span { margin: 0 8px; }

    button {
      padding: 16px 26px;
      margin: 8px;
      font-size: 1.05em;
      font-weight: 700;
      cursor: pointer;
      border-radius: 12px;
      border: none;
      background: var(--primary);
      color: #fff;
      box-shadow: 0 6px 14px rgba(0,0,0,0.15);
      transition: transform 0.08s ease, box-shadow 0.08s ease;
    }

    button:hover { transform: translateY(-1px); box-shadow: 0 10px 18px rgba(0,0,0,0.18); }
    button:active { transform: translateY(0); box-shadow: 0 4px 10px rgba(0,0,0,0.16); }
    button:disabled { background:#9fbada; cursor: not-allowed; box-shadow:none; }

    .secondary { background: var(--secondary); color: #1e2e3a; }

    .card {
      background: #fff;
      padding: clamp(22px, 3vw, 32px);
      border-radius: 18px;
      box-shadow: 0 10px 26px rgba(0,0,0,0.15);
      max-width: 960px;
      width: 100%;
      text-align: center;
    }

    h1, h2, h3 { margin: 0 0 12px 0; font-weight: 800; }
    .subtitle { margin: 6px 0 18px; color: #354b63; }

    #wheelCanvas { border:4px solid #0f1b2d; border-radius:50%; max-width: 360px; width:100%; height:auto; }
    @keyframes spin { from { transform:rotate(0deg);} to{transform:rotate(360deg);} }
    #wheelCanvas.spinning { animation: spin 1s linear 3; }

    .question {
      font-size: clamp(2.2rem, 5vw, 3.4rem);
      font-weight: 800;
      margin: 16px 0 12px;
      color: #0f1b2d;
    }

    .voice-status {
      font-size: 1.05em;
      color: #354b63;
      min-height: 32px;
      margin-bottom: 10px;
    }

    .bad { color: #c0392b; font-weight: 700; }
    .good { color: #1e8449; font-weight: 700; }

    table { border-collapse: collapse; margin: 18px auto; width: 100%; max-width: 640px; font-size: 1.05em; }
    td, th { border: 1px solid #c6d2e2; padding: 10px 14px; text-align: center; }
    th { background: #f1f6fb; }

    .table-preview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 8px;
      margin: 12px 0 4px;
      color: #1b3145;
      font-weight: 600;
    }

    #overlay {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.7);
      display:flex; align-items:center; justify-content:center;
      color:#fff; font-size:1.2rem;
      padding: 14px;
    }
    #overlay .content {
      background:#112132;
      padding:28px;
      border-radius:14px;
      max-width: 520px;
      width: 100%;
      text-align:center;
      box-shadow:0 10px 22px rgba(0,0,0,0.35);
    }
    #overlay.hidden { display:none; }
  </style>
</head>
<body>

<header>
  <div id="header-info">
    <span id="levelDisplay">Level: 1</span>
  </div>
  <button id="highScoresBtn" class="secondary">Table Times</button>
</header>

<main id="main"></main>

<footer>
  <button id="resetBtn">Reset Progress</button>
</footer>

<div id="overlay" class="hidden">
  <div class="content" id="overlayContent"></div>
</div>

<script>
(() => {
  // AUDIO
  const audioSuccess   = new Audio('success.mp3');
  const audioFail      = new Audio('fail.mp3');
  const audioCountdown = new Audio('countdown.mp3');
  const audioSpin      = new Audio('spin.mp3');
  const audioLevelUp   = new Audio('level-up.mp3');

  // SPEECH
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let activeRecognizer = null;
  let keepListening = false;

  // KEYS
  const GAME_KEY = 'mulGameState';
  const HS_KEY   = 'mulTableTimes';

  // MESSAGES
  const CELEBRATIONS = [
    "Great job!", "Well done!", "Fantastic!",
    "You're amazing!", "Keep it up!", "Bravo!",
    "Excellent work!", "You're a star!"
  ];

  let tableStartTime = null;

  // STATE
  const state = { level:1, currentTable:null };

  function saveState(){ localStorage.setItem(GAME_KEY, JSON.stringify(state)); }
  function loadState(){
    const s = localStorage.getItem(GAME_KEY);
    if(s) Object.assign(state, JSON.parse(s));
  }
  function clearState(){ localStorage.removeItem(GAME_KEY); }

  function getHighScores(){
    const v = localStorage.getItem(HS_KEY);
    return v ? JSON.parse(v) : [];
  }
  function saveHighScore(table, timeSeconds, init){
    const hs = getHighScores();
    hs.push({ table, timeSeconds, initials:init, date:new Date().toLocaleDateString() });
    hs.sort((a,b)=>a.timeSeconds - b.timeSeconds);
    localStorage.setItem(HS_KEY, JSON.stringify(hs.slice(0,10)));
  }

  // UI
  const main          = document.getElementById('main');
  const overlay       = document.getElementById('overlay');
  const overlayContent= document.getElementById('overlayContent');
  const levelDisplay  = document.getElementById('levelDisplay');

  function updateHeader(){
    levelDisplay.textContent = 'Level: ' + state.level;
    saveState();
  }

  function showOverlay(html){
    stopListening();
    overlayContent.innerHTML = html;
    overlay.classList.remove('hidden');
  }
  function hideOverlay(){
    overlay.classList.add('hidden');
  }

  document.getElementById('highScoresBtn').onclick = () => {
    const hs = getHighScores();
    let html = `<h2>Fastest Finishes</h2><ol>`;
    if(!hs.length){
      html += `<li>No recorded times yet.</li>`;
    } else {
      hs.forEach(e=> html+=`<li>${e.initials} ‚Äî Table ${e.table} in ${e.timeSeconds}s (${e.date})</li>`);
    }
    html += `</ol><button id="closeHS">Close</button>`;
    showOverlay(html);
    document.getElementById('closeHS').onclick = hideOverlay;
  };

  document.getElementById('resetBtn').onclick = () => {
    if(confirm('Clear progress & recorded times?')){
      clearState(); localStorage.removeItem(HS_KEY);
      location.reload();
    }
  };

  // SPEECH HELPERS
  function stopListening(){
    keepListening = false;
    if(activeRecognizer){
      activeRecognizer.onresult = null;
      activeRecognizer.onerror = null;
      activeRecognizer.onend = null;
      try { activeRecognizer.stop(); } catch(_) {}
      activeRecognizer = null;
    }
  }

  function requireSpeechRecognition(){
    if(!SpeechRecognition){
      showOverlay(`<h2>Voice input unavailable</h2><p>Your browser needs speech recognition (try Chrome or Edge). Keyboard play isn't required, but you may need a supported browser.</p>`);
      return false;
    }
    return true;
  }

  function parseSpokenNumber(text){
    if(!text) return NaN;
    const cleaned = text.toLowerCase();
    const digitMatch = cleaned.match(/\d+/);
    if(digitMatch) return parseInt(digitMatch[0],10);

    const words = cleaned.replace(/[^a-z\s-]/g,' ').split(/\s+/).filter(Boolean);
    const map = {
      zero:0, one:1, two:2, three:3, four:4, five:5, six:6, seven:7, eight:8, nine:9,
      ten:10, eleven:11, twelve:12, thirteen:13, fourteen:14, fifteen:15, sixteen:16, seventeen:17, eighteen:18, nineteen:19,
      twenty:20, thirty:30, forty:40, fifty:50, sixty:60, seventy:70, eighty:80, ninety:90,
      hundred:100
    };
    let total = 0; let current = 0; let found = false;
    words.forEach(w => {
      const val = map[w];
      if(val === undefined) return;
      found = true;
      if(val === 100){
        current = Math.max(1, current) * val;
      } else if(val >= 20){
        current += val;
      } else {
        current += val;
      }
    });
    if(found){
      total += current;
      return total;
    }
    return NaN;
  }

  function listenForNumber(expected, statusEl, onCorrect, onMismatch){
    if(!requireSpeechRecognition()) return;
    stopListening();
    keepListening = true;

    const startRecognition = () => {
      if(!keepListening) return;
      statusEl.textContent = 'Listening...';
      const rec = new SpeechRecognition();
      activeRecognizer = rec;
      rec.lang = 'en-US';
      rec.interimResults = false;
      rec.maxAlternatives = 1;
      rec.continuous = false;

      rec.onresult = (e) => {
        const transcript = Array.from(e.results).map(r=>r[0].transcript).join(' ');
        const val = parseSpokenNumber(transcript);
        if(val === expected){
          keepListening = false;
          statusEl.innerHTML = `<span class="good">Heard "${transcript.trim()}" ‚Üí ${val}. Correct!</span>`;
          audioSuccess.play();
          rec.stop();
          setTimeout(() => onCorrect(transcript.trim(), val), 600);
        } else {
          onMismatch && onMismatch(val, transcript.trim());
          audioFail.play();
          statusEl.innerHTML = `<span class="bad">Heard "${transcript.trim()}"${isNaN(val)?'':` ‚Üí ${val}`} ‚Äî try again.</span>`;
        }
      };

      rec.onerror = () => {
        statusEl.textContent = 'Had trouble hearing you. Trying again...';
      };

      rec.onend = () => {
        if(keepListening) setTimeout(startRecognition, 250);
      };

      rec.start();
    };

    startRecognition();
  }

  // FLOW
  function startGame(){
    stopListening();
    loadState();
    if(state.level>1 && confirm(`Continue at Level ${state.level}?`)){
      nextStep();
    } else {
      clearState();
      state.level=1; state.currentTable=null;
      saveState();
      nextStep();
    }
  }

  function nextStep(){
    updateHeader();
    if(state.level>10) return winGame();
    if(state.level%2===1) spinWheel();
    else                    startQuiz();
  }

  // WHEEL
  function spinWheel(){
    stopListening();
    main.innerHTML = `
      <div class="card">
        <h2>Spin to pick a table</h2>
        <canvas id="wheelCanvas" width="360" height="360"></canvas>
        <p class="subtitle">Every table up to 10 is waiting for you. Tap the wheel and get ready to speak your answers!</p>
        <button id="spinBtn">Spin the Wheel</button>
      </div>`;
    const canvas = document.getElementById('wheelCanvas');
    const ctx    = canvas.getContext('2d');
    const R=160, seg=10;
    for(let i=0;i<seg;i++){
      const a=(i/seg)*2*Math.PI;
      ctx.beginPath();
      ctx.moveTo(180,180);
      ctx.arc(180,180,R, a, a+2*Math.PI/seg);
      ctx.fillStyle=`hsl(${i*36},70%,60%)`;
      ctx.fill(); ctx.stroke();
      ctx.save();
      ctx.translate(180,180);
      ctx.rotate(a+Math.PI/seg);
      ctx.fillStyle='#000';
      ctx.font = 'bold 26px sans-serif';
      ctx.fillText(i+1, R*0.6,8);
      ctx.restore();
    }
    ctx.fillStyle='red';
    ctx.beginPath();
    ctx.moveTo(180,16); ctx.lineTo(166,50); ctx.lineTo(194,50);
    ctx.fill();

    const btn = document.getElementById('spinBtn');
    btn.onclick = () => {
      audioSpin.play();
      btn.disabled = true;
      canvas.classList.add('spinning');
      setTimeout(()=>{
        canvas.classList.remove('spinning');
        const pick = Math.floor(Math.random()*10)+1;
        state.currentTable = pick;
        tableStartTime = null;
        saveState();
        audioLevelUp.play();
        showOverlay(`
          <h2>üéâ Table of ${pick}! üéâ</h2>
          <p>${CELEBRATIONS[Math.floor(Math.random()*CELEBRATIONS.length)]}</p>
          <p>We'll listen for your answers ‚Äî no typing needed.</p>
          <button id="gotable">Go!</button>`);
        document.getElementById('gotable').onclick = () => {
          hideOverlay();
          startAdditionPractice();
        };
      },3000);
    };
  }

  // ADDITION PRACTICE
  function startAdditionPractice(){
    stopListening();
    const n = state.currentTable;
    let step = 0;

    main.innerHTML = `
      <div class="card">
        <h2>Practice Adding ${n}</h2>
        <p class="subtitle">Say each answer out loud. We'll keep listening until it's correct.</p>
        <div class="question" id="addQ">0 + ${n} = ?</div>
        <div class="voice-status" id="addStatus">Press start to begin listening.</div>
        <button id="addSubmit">Start Listening</button>
      </div>
    `;

    const btn      = document.getElementById('addSubmit');
    const qEl      = document.getElementById('addQ');
    const statusEl = document.getElementById('addStatus');

    const ask = () => {
      const expected = (step+1) * n;
      qEl.textContent = `${step*n} + ${n} = ?`;
      statusEl.textContent = `Say "${expected}" to move on.`;
      listenForNumber(expected, statusEl, () => {
        step++;
        if(step === 10){
          audioLevelUp.play();
          updateHeader();
          showOverlay(`
            <h2>${CELEBRATIONS[Math.floor(Math.random()*CELEBRATIONS.length)]}</h2>
            <p>Let's fill in a few blanks for ${n}.</p>
            <button id="contFill">Continue</button>`);
          document.getElementById('contFill').onclick = () => {
            hideOverlay();
            startFillMode();
          };
          return;
        }
        statusEl.textContent = 'Great! Next one coming up...';
        setTimeout(ask, 700);
      }, () => {});
    };

    btn.onclick = () => {
      if(!requireSpeechRecognition()) return;
      btn.disabled = true;
      tableStartTime = Date.now();
      ask();
    };
  }

  // FILL-IN (odd levels)
  function startFillMode(){
    stopListening();
    const n = state.currentTable;
    const bmap={1:4,3:4,5:5,7:6,9:7};
    const blankCount = bmap[state.level]||4;

    const all = Array.from({length:10},(_,i)=>i+1);
    const blanks = shuffle(all.slice()).slice(0,blankCount);
    let idx = 0;

    main.innerHTML = `<div class="card">
      <h2>Table of ${n} ‚Äî Fill ${blankCount} Blanks</h2>
      <p class="subtitle">We'll ask you only the missing answers. Speak them aloud.</p>
      <div class="question" id="fillQuestion">Ready?</div>
      <div class="voice-status" id="fillStatus">Press start to begin listening.</div>
      <div class="table-preview">${all.map(i=>`<div>${n} √ó ${i} = ${blanks.includes(i)?'‚ùì':'<strong>'+n*i+'</strong>'}</div>`).join('')}</div>
      <button id="fillStartBtn">Start Listening</button>
    </div>`;

    const statusEl = document.getElementById('fillStatus');
    const qEl = document.getElementById('fillQuestion');

    const ask = () => {
      const i = blanks[idx];
      const expected = n * i;
      qEl.textContent = `${n} √ó ${i} = ?`;
      statusEl.textContent = `Say "${expected}"`;
      listenForNumber(expected, statusEl, () => {
        idx++;
        if(idx >= blanks.length){
          audioLevelUp.play();
          updateHeader();
          showOverlay(`
            <h2>üéâ ${CELEBRATIONS[Math.floor(Math.random()*CELEBRATIONS.length)]}</h2>
            <p>Get ready for a quick voice quiz on ${n}.</p>
            <button id="nextlvl">Continue</button>`);
          document.getElementById('nextlvl').onclick = () => {
            hideOverlay();
            state.level++;
            saveState();
            nextStep();
          };
          return;
        }
        statusEl.textContent = 'Nice! Here comes the next blank...';
        setTimeout(ask, 700);
      }, () => {});
    };

    document.getElementById('fillStartBtn').onclick = () => {
      if(!requireSpeechRecognition()) return;
      if(!tableStartTime) tableStartTime = Date.now();
      document.getElementById('fillStartBtn').disabled = true;
      ask();
    };
  }

  // QUIZ (even levels)
  function startQuiz(){
    stopListening();
    const n = state.currentTable;
    let qIdx=0;
    const questions = shuffle(Array.from({length:10},(_,i)=>i+1));

    main.innerHTML = `
      <div class="card">
        <h2>Table of ${n} ‚Äî Voice Quiz</h2>
        <p class="subtitle">Say each answer. We'll listen until it's right.</p>
        <div id="question" class="question">Press start</div>
        <div class="voice-status" id="quizStatus">Press start to begin listening.</div>
        <button id="submitQ">Start Listening</button>
      </div>
    `;

    const btn      = document.getElementById('submitQ');
    const statusEl = document.getElementById('quizStatus');
    const qEl      = document.getElementById('question');

    const ask = () => {
      const expected = n * questions[qIdx];
      qEl.textContent = `${n} √ó ${questions[qIdx]} = ?`;
      statusEl.textContent = `Say "${expected}"`;
      listenForNumber(expected, statusEl, () => {
        qIdx++;
        if(qIdx>=questions.length){
          const totalTime = Math.round((Date.now() - tableStartTime)/1000);
          audioLevelUp.play();
          updateHeader();
          const input = prompt('Enter your initials to record your time:', '');
          const init  = input ? input.toUpperCase().slice(0,3) : '';
          if(init) saveHighScore(n, totalTime, init);
          showOverlay(`
            <h2>üéâ ${CELEBRATIONS[Math.floor(Math.random()*CELEBRATIONS.length)]}</h2>
            <p>Total Time: ${totalTime}s</p>
            <button id="nextlvl2">Next Level</button>`);
          document.getElementById('nextlvl2').onclick = () => {
            hideOverlay();
            state.level++;
            saveState();
            nextStep();
          };
          return;
        }
        statusEl.textContent = 'Correct! Next question coming...';
        setTimeout(ask, 700);
      }, () => {});
    };

    btn.onclick = () => {
      if(!requireSpeechRecognition()) return;
      btn.disabled = true;
      if(!tableStartTime) tableStartTime = Date.now();
      ask();
    };
  }

  // WIN
  function winGame(){
    stopListening();
    audioCountdown.pause();
    audioSuccess.play();
    main.innerHTML = `<div class="card"><h2>üéâ You Won the Game! üéâ</h2>
      <p>You finished all the tables!</p></div>`;
    setTimeout(()=>{
      showOverlay(`
        <h2>Congratulations!</h2>
        <p>Great work mastering your tables.</p>
        <button id="replay2">Play Again</button>`);
      document.getElementById('replay2').onclick = () => {
        audioCountdown.currentTime = 0;
        hideOverlay();
        startGame();
      };
    },200);
  }

  // SHUFFLE
  function shuffle(a){
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]] = [a[j],a[i]];
    }
    return a;
  }

  // START
  startGame();

})();
</script>
</body>
</html>
